rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() { 
      return request.auth != null; 
    }
    
    function isOwner(userId) { 
      return isSignedIn() && request.auth.uid == userId; 
    }
    
    function isAdmin() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/players/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/players/$(request.auth.uid)).data.isAdmin == true;
    }

    // === 1. Players ===
    match /players/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      // Allow owner/admin update, OR allow adding to friends list (two-way acceptance)
      allow update: if isOwner(userId) || isAdmin() || 
                   (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friends']));
      allow delete: if isAdmin();
    }

    // === 2. Subjects (with subcollections) ===
    match /subjects/{subjectId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
      
      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
        
        // Questions subcollection
        match /questions/{questionId} {
          allow read: if isSignedIn();
          allow write: if isAdmin();
        }
      }
    }

    // === 3. Legacy Collections (for backward compatibility during migration) ===
    // These can be removed after migration is complete
    match /quizzes/{id} { 
      allow read: if isSignedIn(); 
      allow write: if isAdmin(); 
    }
    
    match /questions/{id} { 
      allow read: if isSignedIn(); 
      allow write: if isAdmin(); 
    }

    // === 4. Note: friend_requests and game_invites moved to Realtime Database ===
    // No Firestore rules needed for these anymore
  }
}

